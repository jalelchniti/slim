import React, { useState, useEffect, useRef } from 'react';
import { motion } from 'framer-motion';
import { useNavigate } from 'react-router-dom';
import { Button } from '../../../components/ui/button';
import { ChevronLeft, ChevronRight, Volume2, RotateCcw } from 'lucide-react';

// Define Flashcard interface
interface Flashcard {
  id: number | string;
  front: string; // Prompt or question (e.g., definition, incomplete sentence)
  back: string;  // Answer or key term (e.g., word, complete sentence)
}

// Sample flashcards data
const flashcards: Flashcard[] = [
  { id: 1, front: "I ___ book a flight.", back: "I need to book a flight." },
  { id: 2, front: "She ___ attend the meeting yesterday.", back: "She couldn't attend the meeting yesterday." },
  { id: 3, front: "They ___ working on the project for two weeks.", back: "They have been working on the project for two weeks." },
  { id: 4, front: "We ___ to the beach last summer.", back: "We went to the beach last summer." },
  { id: 5, front: "He ___ speak English fluently.", back: "He can speak English fluently." },
];

const VocabularyFlashcards: React.FC = () => {
  const [currentCard, setCurrentCard] = useState<number>(0);
  const [isFlipped, setIsFlipped] = useState<boolean>(false);
  const isSpeakingRef = useRef<boolean>(false);
  const navigate = useNavigate();

  // Function to play text-to-speech
  const speakText = (text: string) => {
    if (isSpeakingRef.current) {
      window.speechSynthesis.cancel();
    }

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US';

    // Try to find a US English voice, otherwise use the first available voice
    const voices = window.speechSynthesis.getVoices();
    const usVoice = voices.find(voice => voice.lang === 'en-US');
    if (usVoice) {
      utterance.voice = usVoice;
    }

    isSpeakingRef.current = true;
    utterance.onend = () => {
      isSpeakingRef.current = false;
    };

    window.speechSynthesis.speak(utterance);
  };

  // Handle card flip
  const handleFlip = () => {
    setIsFlipped(!isFlipped);
    if (!isFlipped) {
      // When flipping to back, speak the back content
      speakText(flashcards[currentCard].back);
    }
  };

  // Navigate to previous card
  const handlePrevious = () => {
    setIsFlipped(false);
    setCurrentCard((prev) => (prev === 0 ? flashcards.length - 1 : prev - 1));
  };

  // Navigate to next card
  const handleNext = () => {
    setIsFlipped(false);
    setCurrentCard((prev) => (prev + 1) % flashcards.length);
  };

  // Replay current audio
  const handleReplayAudio = () => {
    speakText(isFlipped ? flashcards[currentCard].back : flashcards[currentCard].front);
  };

  // Load voices when component mounts
  useEffect(() => {
    if (typeof window !== 'undefined' && window.speechSynthesis) {
      // Load voices if they're not already loaded
      if (window.speechSynthesis.getVoices().length === 0) {
        window.speechSynthesis.onvoiceschanged = () => {
          // Voices are now loaded
        };
      }
    }
  }, []);

  return (
    <div className="max-w-5xl mx-auto p-6 bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl shadow-xl min-h-screen flex flex-col items-center">
      <h1 className="text-4xl font-bold text-indigo-700 mb-8 text-center">Vocabulary Flashcards</h1>
      
      {/* Card Container */}
      <motion.div
        className="relative w-[460px] h-[288px] mx-auto cursor-pointer"
        onClick={handleFlip}
        animate={{ rotateY: isFlipped ? 180 : 0 }}
        transition={{ duration: 0.6 }}
        style={{ transformStyle: 'preserve-3d' }}
        whileHover={{ scale: 1.02 }}
      >
        {/* Front of Card */}
        <div 
          className="absolute w-full h-full bg-white rounded-xl shadow-lg border border-gray-200 flex items-center justify-center p-6"
          style={{ backfaceVisibility: 'hidden' }}
        >
          <p className="text-2xl font-medium text-indigo-600 text-center">{flashcards[currentCard].front}</p>
        </div>
        
        {/* Back of Card */}
        <div 
          className="absolute w-full h-full bg-indigo-50 rounded-xl shadow-lg border border-indigo-200 flex items-center justify-center p-6"
          style={{ 
            backfaceVisibility: 'hidden', 
            transform: 'rotateY(180deg)'
          }}
        >
          <p className="text-2xl font-medium text-gray-800 text-center">{flashcards[currentCard].back}</p>
        </div>
      </motion.div>
      
      {/* Navigation Controls */}
      <div className="flex justify-between mt-10 max-w-md mx-auto w-full">
        <motion.button
          className="px-6 py-3 bg-indigo-600 text-white rounded-full flex items-center"
          onClick={handlePrevious}
          whileHover={{ scale: 1.05 }}
          whileTap={{ scale: 0.95 }}
        >
          <ChevronLeft className="mr-1" size={20} />
          Previous
        </motion.button>
        
        <p className="flex items-center text-gray-600">
          Card {currentCard + 1} of {flashcards.length}
        </p>
        
        <motion.button
          className="px-6 py-3 bg-indigo-600 text-white rounded-full flex items-center"
          onClick={handleNext}
          whileHover={{ scale: 1.05 }}
          whileTap={{ scale: 0.95 }}
        >
          Next
          <ChevronRight className="ml-1" size={20} />
        </motion.button>
      </div>
      
      {/* Action Buttons */}
      <div className="flex flex-col items-center mt-6">
        <motion.button
          className="mt-6 px-4 py-2 bg-blue-600 text-white rounded-full flex items-center"
          onClick={handleReplayAudio}
          whileHover={{ scale: 1.05 }}
          whileTap={{ scale: 0.95 }}
        >
          <Volume2 className="mr-2" size={18} />
          Replay Audio
        </motion.button>
        
        <motion.button
          className="mt-6 px-6 py-3 bg-green-600 text-white rounded-full flex items-center"
          onClick={() => navigate('/vocabulary-quiz')}
          whileHover={{ scale: 1.05 }}
          whileTap={{ scale: 0.95 }}
        >
          <RotateCcw className="mr-2" size={18} />
          Go to Quiz
        </motion.button>
      </div>
    </div>
  );
};

export default VocabularyFlashcards;
